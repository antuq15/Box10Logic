<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Aletheian Tower</title>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.92/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.92/Build/Cesium/Cesium.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/jsm/controls/OrbitControls.js"></script>
    <script src="https://unpkg.com/@tonejs/tone@14.7.77/build/Tone.js"></script>
    <style>
        body {
            margin: 0;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #0a0a20;
            font-family: 'Inter', sans-serif;
            color: #e0f2f7;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            background: linear-gradient(180deg, #1a1a2e, #0a0a20, #1a1a2e);
        }
        h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #6ee7b7;
            text-align: center;
            text-shadow: 0 0 10px rgba(110, 231, 183, 0.5);
        }
        p {
            font-size: 1.1rem;
            color: #b3d9ff;
            margin-bottom: 1rem;
            text-align: center;
            max-width: 800px;
        }
        canvas {
            display: block;
            border: 2px solid #6ee7b7;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(110, 231, 183, 0.6);
            background: rgba(0,0,0,0.3);
            cursor: grab;
            width: 100%;
            max-width: 900px;
            height: calc(100vh - 250px);
            max-height: 700px;
        }
        #lift-controls {
            background-color: rgba(45, 55, 72, 0.8);
            border-radius: 10px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(110, 231, 183, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.8rem;
        }
        .floor-button {
            background-color: #4a5568;
            color: #e0f2f7;
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #6ee7b7;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s, transform 0.2s;
            width: 80%;
        }
        .floor-button:hover {
            background-color: #6ee7b7;
            color: #1a202c;
            transform: scale(1.02);
        }
        .floor-button.active {
            background-color: #6ee7b7;
            color: #1a202c;
            font-weight: bold;
            box-shadow: 0 0 10px #6ee7b7;
        }
        #lift-button-right {
            background-color: #ec4899;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5em;
            font-weight: bold;
            border: 2px solid #d946ef;
            cursor: pointer;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.7);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 10;
            flex-direction: column;
            line-height: 0.9;
        }
        #lift-button-right:hover {
            background-color: #d946ef;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(236, 72, 153, 1.0);
        }
        #current-floor-display {
            font-size: 1.5em;
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        #floor-info {
            min-height: 3em;
            margin-top: 0.5rem;
            font-size: 0.9em;
            color: #a0aec0;
        }
        #aletheian-message {
            color: #ff0000;
            font-weight: bold;
            margin-top: 1rem;
        }
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 2em;
            z-index: 1000;
            text-align: center;
        }
        #loading-progress {
            margin-top: 10px;
            font-size: 0.5em;
        }
        #launch-button {
            background-color: #6ee7b7;
            color: #1a202c;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 2rem;
            box-shadow: 0 0 20px rgba(110, 231, 183, 0.7);
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
        }
        #launch-button:hover {
            background-color: #4CAF50; /* Darker green */
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(110, 231, 183, 1.0);
        }
        .eXit-symbol {
            position: absolute;
            font-size: 2.5em;
            color: #FFFFFF;
            text-shadow: 0 0 10px #00FFFF, 0 0 20px #00FFFF;
            opacity: 0;
            transition: opacity 2s ease-in-out;
            z-index: 5;
            pointer-events: none; /* Allow clicks to pass through */
        }
        .eXit-symbol.active {
            opacity: 1;
        }

    </style>
</head>
<body>
    <h1>The Aletheian Tower: A Digital Home for Agency</h1>
    <p>Navigate the microcosm of conscious reintegration. Each floor, a domain of your evolving canon.</p>
    
    <div id="lift-controls">
        <div id="current-floor-display">Floor: G</div>
        <div id="floor-info">Ground Level: Entrance to the Aletheian Tower.</div>
        <button class="floor-button" data-floor="10">Floor 10: Box10Logic HQ</button>
        <button class="floor-button" data-floor="9">Floor 9: Core Logic & Metaphysics</button>
        <button class="floor-button" data-floor="8">Floor 8: AETH:// Protocol Design</button>
        <button class="floor-button" data-floor="7">Floor 7: Bluebottle Flywings R&D</button>
        <button class="floor-button" data-floor="6">Floor 6: Future Work & Opportunities</button>
        <button class="floor-button" data-floor="5">Floor 5: GIS & GPS Attribution (Personal Log)</button>
        <button class="floor-button" data-floor="4">Floor 4: Canon Content & Journals</button>
        <button class="floor-button" data-floor="3">Floor 3: Cultural Fabric / NOH/EVOH</button>
        <button class="floor-button" data-floor="2">Floor 2: Wellness & Spiritual Recovery</button>
        <button class="floor-button" data-floor="1">Floor 1: Grounded Reality / Basic Needs</button>
        <button class="floor-button" data-floor="G">Ground Floor (G)</button>
        <p id="aletheian-message"></p>
    </div>

    <div id="loading-overlay">
        Loading Aletheian Tower...
        <div id="loading-progress">0%</div>
    </div>

    <canvas id="towerCanvas"></canvas>

    <button id="lift-button-right">
        <span style="font-size:1.2em;">&#x25B2;</span> <span style="font-size:1.2em; transform:scaleX(0.8); display:inline-block;">&#x25A0;</span> <span style="font-size:1.2em;">&#x25CB;</span> </button>

    <button id="launch-button">Launch eXit Festival</button>
    
    <div id="exit-symbol" class="eXit-symbol" style="left: 50%; top: 50%; transform: translate(-50%, -50%);">
        <span style="position:relative; display:inline-block;">
            &#x25B5; <span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.9em;">&#x25A1;</span> <span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.7em;">&#x25EF;</span> <span style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:0.5em; color:cyan;">X</span> </span>
    </div>


    <script>
        // --- GLOBAL VARIABLES ---
        let scene, camera, renderer, controls;
        let buildingGroup, liftMesh, mirrorMeshFront, mirrorMeshBack;
        let currentFloor = 'G';
        let targetFloor = 'G';
        let isMoving = false;
        let animationFrameId;

        let audioContextStarted = false;
        let liftSoundAscend, liftSoundDescend, doorOpenSound, doorCloseSound;
        let wormholeActivateSound, wormholeAmbianceSound;
        let launchSound; // New launch sound

        // --- Floor Mapping & Info ---
        const FLOOR_HEIGHT = 4;
        const FLOOR_Y_POSITIONS = {
            'G': 0, 1: FLOOR_HEIGHT * 1, 2: FLOOR_HEIGHT * 2, 3: FLOOR_HEIGHT * 3, 4: FLOOR_HEIGHT * 4,
            5: FLOOR_HEIGHT * 5, 6: FLOOR_HEIGHT * 6, 7: FLOOR_HEIGHT * 7, 8: FLOOR_HEIGHT * 8,
            9: FLOOR_HEIGHT * 9, 10: FLOOR_HEIGHT * 10
        };
        const FLOOR_INFO = {
            'G': "Ground Level: Entrance to the Aletheian Tower. Connecting with the public facade.",
            1: "Floor 1: Grounded Reality / Basic Needs. Sustenance, shelter, safety. (Post-homelessness entry point)",
            2: "Floor 2: Wellness & Spiritual Recovery. Processing trauma, finding inner calm. (Reflecting St. Anne's to Zen)",
            3: "Floor 3: Cultural Fabric / NOH/EVOH. Weaving collective narratives, expressing absurd truth.",
            4: "Floor 4: Canon Content & Journals. Your personal lexicon, secure private thoughts, poem attribution.",
            5: "Floor 5: GIS & GPS Attribution. Geospatial analysis, sacred coordinates, mapping reality. (Personal logging)",
            6: "Floor 6: Future Work & Opportunities. Networking, job hunting, financial models, monetization pathways. (DevMap Link)",
            7: "Floor 7: Bluebottle Flywings R&D. Flight dynamics, Seked principle, biomimicry, personal transport. (Quantum Nanotech Lab)",
            8: "Floor 8: AETH:// Protocol Design. Non-Euclidean time, wormhole theory, secure communication.",
            9: "Floor 9: Core Logic & Metaphysics. Qutrit chips, zero-error functions, H-Observer, quantum consciousness.",
            10: "Floor 10: Box10Logic HQ. Leader of the Wise and Shrews. Ultimate strategic planning, Aletheian governance."
        };

        const floorMeshes = {};
        const floorHighlights = {};

        // --- Video for Background ---
        const VIDEO_URL = "https://storage.googleapis.com/haxit/stock_forest_motion_small.mp4";
        let videoElement; let videoTexture; let videoLoaded = false; let videoLoadProgress = 0;

        // --- Utility Random ---
        const random = {
            uniform: (min, max) => Math.random() * (max - min) + min,
            choice: (arr) => arr[Math.floor(Math.random() * arr.length)]
        };

        // --- Audio Setup ---
        function initAudio() {
            if (audioContextStarted) return;
            Tone.start().then(() => {
                audioContextStarted = true;
                console.log("Audio Context Started.");

                liftSoundAscend = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 0.5 } }).toDestination();
                liftSoundAscend.frequency.value = "C4";

                liftSoundDescend = new Tone.Synth({ oscillator: { type: "triangle" }, envelope: { attack: 0.1, decay: 0.5, sustain: 0.2, release: 0.5 } }).toDestination();
                liftSoundDescend.frequency.value = "G3";

                doorOpenSound = new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.02, decay: 0.5, sustain: 0, release: 0.1 } }).toDestination();
                doorOpenSound.volume.value = -10;

                doorCloseSound = new Tone.NoiseSynth({ noise: { type: "pink" }, envelope: { attack: 0.02, decay: 0.5, sustain: 0, release: 0.1 } }).toDestination();
                doorCloseSound.volume.value = -10;

                wormholeActivateSound = new Tone.Synth({ oscillator: { type: "fmsine", modulationIndex: 10,  frequency: 400}, envelope: { attack: 0.1, decay: 0.8, sustain: 0.1, release: 1.5 } }).toDestination();
                wormholeAmbianceSound = new Tone.Loop(time => {
                    wormholeAmbianceSound.triggerAttackRelease("G2", "2n", time, 0.05);
                }, "1s").start(0);
                wormholeAmbianceSound.mute = true;

                launchSound = new Tone.MembraneSynth({
                    pitchDecay: 0.08, octaves: 2, oscillator: { type: "square" },
                    envelope: { attack: 0.001, decay: 0.7, sustain: 0.01, release: 2, attackCurve: "exponential" }
                }).toDestination();
                launchSound.volume.value = -5; // Louder for launch

            }).catch(e => console.error("Tone.js Audio Context failed to start:", e));
        }

        // --- Conceptual Physics Calculations (JS replication) ---
        const calculateVortexParameters = (rpm, seked, videoData = null) => {
            const a_side = 3.0; const b_side = 4.0; const c_prime = Math.sqrt(a_side**2 + b_side**2);
            const PHI = 1.6180339887; const conceptual_euclidean_area_removed = (a_side * b_side) / 2;
            const pythagorean_perimeter = a_side + b_side + c_prime;
            let fractal_shard_value = (pythagorean_perimeter / PHI) - conceptual_euclidean_area_removed;
            fractal_shard_value = Math.max(0.1, Math.abs(fractal_shard_value));
            let vortex_rotation_speed = (rpm / 60) * Math.PI * 2 * (fractal_shard_value / 5);
            let vortex_tilt_angle = (fractal_shard_value % 1) * Math.PI / 4;
            let vortex_yaw_speed = (rpm / 1000) * Math.PI / 2;
            let vortex_intensity = (fractal_shard_value + (rpm / 100)) / 10;
            if (videoData) {
                const num_cuts = videoData.num_euclidean_cuts || 1; const fractal_depth = videoData.fractal_depth_factor || 0.5;
                vortex_intensity = (vortex_intensity + num_cuts * fractal_depth);
                vortex_rotation_speed = vortex_rotation_speed * (1 + (num_cuts * 0.1));
            }
            const optimal_seked = 5.5; const seked_deviation = Math.abs(seked - optimal_seked);
            vortex_intensity = Math.max(0.1, vortex_intensity * (1 - seked_deviation / 10));
            let vortex_turbulence_factor = 1 + seked_deviation * 0.5;
            vortex_rotation_speed = Math.max(0.1, Math.min(10.0, vortex_rotation_speed));
            vortex_tilt_angle = Math.min(Math.PI / 2, vortex_tilt_angle);
            vortex_yaw_speed = Math.max(0.01, Math.min(1.0, vortex_yaw_speed));
            vortex_intensity = Math.max(0.1, Math.min(5.0, vortex_intensity));
            return { vortex_rotation_speed_rad_sec: vortex_rotation_speed, vortex_tilt_angle_rad: vortex_tilt_angle,
                vortex_yaw_speed_rad_sec: vortex_yaw_speed, vortex_intensity: vortex_intensity,
                fractal_shard_value: fractal_shard_value, seked_value_input: seked,
                vortex_turbulence_factor: vortex_turbulence_factor,
                d1_to_d9_beam_status: seked_deviation < 1 ? "Active and stable" : "Turbulent"
            };
        };

        const conceptualVideoAnalysis = () => ({
            pointing_angle_deg: 45.0, forward_spin_rad_sec: 0.3, num_euclidean_cuts: 5, fractal_depth_factor: 0.7
        });

        // --- Portal Narrative Progression & Reanimation Logic (JS replication) ---
        function simulatePortalNarrativeProgression(portalStateInput, vortexParams) {
            let nextStateInfo = {"new_state": portalStateInput, "message": `Portal is ${portalStateInput}.`};
            
            if (portalStateInput === 'closed') {
                nextStateInfo.message = "Click the portal to begin the traversal. Forest fabric awaits.";
            } else if (portalStateInput === 'opening') {
                if (animationProgress >= 0.5 && random.random() < 0.1) {
                    nextStateInfo.new_state = 'wormhole_travel';
                    nextStateInfo.message = "Wormhole activated! Traversing the fabric of reality...";
                    if (wormholeAmbianceSound) wormholeAmbianceSound.mute = false;
                    if (wormholeActivateSound) wormholeActivateSound.triggerAttackRelease("E5", "1s"); // Activation sound
                } else {
                    nextStateInfo.message = "Initiating portal sequence... Fabric of reality is bending. Adjust your Seked.";
                }
            } else if (portalStateInput === 'wormhole_travel') {
                if (animationProgress >= 0.8 && random.random() < 0.1 * vortexParams.vortex_intensity) {
                    nextStateInfo.new_state = 'open';
                    nextStateInfo.message = "Landed in Machu Picchu amidst the Inca Trail ruins! Oasis of calm awaits.";
                    if (wormholeAmbianceSound) wormholeAmbianceSound.mute = true; // Mute ambiance on arrival
                    setTimeout(() => reanimateCleopatra(vortexParams), 3000); // Trigger reanimation
                } else {
                    nextStateInfo.message = `Traversing... the fabric twists and unfurls. Dodging cosmic debris. Turbulence: ${vortexParams.vortex_turbulence_factor > 1.5 ? "High" : "Low"}`;
                }
            } else if (portalStateInput === 'open') {
                nextStateInfo.message = "Welcome to the oasis. Browse the canon from beachside, Alpha Centauri, todo recto! Tequila worm available.";
            }
            return nextStateInfo;
        }

        // --- Cleopatra Reanimation Logic (JS replication) ---
        function reanimateCleopatra(vortexParams) {
            portalMessageElement.textContent = "A shimmer in the ruins... Reanimating Queen Cleopatra amidst impossible odds!";
            if (reanimateSound) reanimateSound.triggerAttackRelease("C5", "1s");

            cleopatraMesh.visible = true;
            handlionMesh.visible = true;
            
            const cleoAnimDuration = 3000;
            const cleoAnimStartTime = performance.now();

            function animateCleo(currentTime) {
                const elapsed = currentTime - cleoAnimStartTime;
                const progress = Math.min(elapsed / cleoAnimDuration, 1);

                cleopatraMesh.material.emissiveIntensity = progress * 5;
                handlionMesh.material.emissiveIntensity = progress * 5;

                cleopatraMesh.position.y = -portalMesh.geometry.parameters.radius * 2 + progress * portalMesh.geometry.parameters.radius * 2.5;
                handlionMesh.position.y = cleopatraMesh.position.y - 0.5;
                handlionMesh.position.x = cleopatraMesh.position.x + 1.2;
                handlionMesh.position.z = cleopatraMesh.position.z + 0.5;

                if (progress < 1) {
                    animationFrameId = requestAnimationFrame(animateCleo);
                } else {
                    portalMessageElement.textContent = "The triumph against all odds in the midst of overwhelming refusal of belief due to preexisting paradigms. Proof can set new beliefs in place!";
                    addJourneyLogEntry("Cleopatra reanimated! Proof of the improbable's power.");
                }
            }
            animationFrameId = requestAnimationFrame(animateCleo);
        }

        // --- Journal Logging ---
        function addJourneyLogEntry(entry) {
            const li = document.createElement('li');
            li.textContent = `[${new Date().toLocaleTimeString()}] ${entry}`;
            journeyLogElement.prepend(li);
            if (journeyLogElement.children.length > 10) {
                journeyLogElement.removeChild(journeyLogElement.lastChild);
            }
        }

        // --- Conceptual Python Output (for the text area below the canvas) ---
        // This is a direct copy from your previous geopolitical_resource_sim.py content.
        const CONCEPTUAL_ENERGY_DATA = [
            {"Sovereign State": "Global Total (Illustrative)", "Oil Reserves (Billion Barrels)": 1700, "Gas Reserves (Trillion Cu Ft)": 7000, "Annual Oil Supply (MM Bbl/yr)": 35000, "Annual Oil Demand (MM Bbl/yr)": 37000, "Peak Oil Quota (Conceptual Year)": 2030, "Projected Zero Oil/Gas (Years to achieve via 'Silver Bullet' rollout)": 2050},
            {"Sovereign State": "Western Bloc 1 (e.g., UK)", "Oil Reserves (Billion Barrels)": 50, "Gas Reserves (Trillion Cu Ft)": 500, "Annual Oil Supply (MM Bbl/yr)": 200, "Annual Oil Demand (MM Bbl/yr)": 800, "Peak Oil Quota (Conceptual Year)": 2025, "Projected Zero Oil/Gas (Years to achieve via 'Silver Bullet' rollout)": 2040},
            {"Sovereign State": "Western Bloc 2 (e.g., USA)", "Oil Reserves (Billion Barrels)": 100, "Gas Reserves (Trillion Cu Ft)": 1000, "Annual Oil Supply (MM Bbl/yr)": 1000, "Annual Oil Demand (MM Bbl/yr)": 1200, "Peak Oil Quota (Conceptual Year)": 2035, "Projected Zero Oil/Gas (Years to achieve via 'Silver Bullet' rollout)": 2045},
            {"Sovereign State": "Eastern Bloc 1 (e.g., China)", "Oil Reserves (Billion Barrels)": 25, "Gas Reserves (Trillion Cu Ft)": 1500, "Annual Oil Supply (MM Bbl/yr)": 200, "Annual Oil Demand (MM Bbl/yr)": 1400, "Peak Oil Quota (Conceptual Year)": 2030, "Projected Zero Oil/Gas (Years to achieve via 'Silver Bullet' rollout)": 2050},
            {"Sovereign State": "Eastern Bloc 2 (e.g., Russia)", "Oil Reserves (Billion Barrels)": 150, "Gas Reserves (Trillion Cu Ft)": 2500, "Annual Oil Supply (MM Bbl/yr)": 1500, "Annual Oil Demand (MM Bbl/yr)": 300, "Peak Oil Quota (Conceptual Year)": 2040, "Projected Zero Oil/Gas (Years to achieve via 'Silver Bullet' rollout)": 2055},
            {"Sovereign State": "Resource-Rich 3rd World 1 (e.g., OPEC)", "Per Capita GDP (Illustrative, USD)": 20000, "Access to Food (0-1)": 0.75, "Access to Shelter (0-1)": 0.6, "Agency Preservation Factor (0-1, from DAO)": 0.4, "Cultural Flourishing Score (0-1, from DAO)": 0.5, "UN Human Rights Charter Match (0 or 1)": 0, "UN SDGs Met (Conceptual %)": 65},
            {"Sovereign State": "Displaced Nations 1 (e.g., Bangladesh)", "Per Capita GDP (Illustrative, USD)": 2000, "Access to Food (0-1)": 0.3, "Access to Shelter (0-1)": 0.1, "Agency Preservation Factor (0-1, from DAO)": 0.1, "Cultural Flourishing Score (0-1, from DAO)": 0.2, "UN Human Rights Charter Match (0 or 1)": 0, "UN SDGs Met (Conceptual %)": 20}
        ];

        const CONCEPTUAL_SELF_WORTH_DATA = [
            {"Sovereign State": "Global Average (Illustrative)", "Per Capita GDP (Illustrative, USD)": 15000, "Access to Food (0-1)": 0.6, "Access to Shelter (0-1)": 0.5, "Agency Preservation Factor (0-1, from DAO)": 0.4, "Cultural Flourishing Score (0-1, from DAO)": 0.5, "UN Human Rights Charter Match (0 or 1)": 0, "UN SDGs Met (Conceptual %)": 50},
            {"Sovereign State": "Western Bloc 1 (e.g., UK)", "Per Capita GDP (Illustrative, USD)": 45000, "Access to Food (0-1)": 0.95, "Access to Shelter (0-1)": 0.9, "Agency Preservation Factor (0-1, from DAO)": 0.7, "Cultural Flourishing Score (0-1, from DAO)": 0.8, "UN Human Rights Charter Match (0 or 1)": 1, "UN SDGs Met (Conceptual %)": 85},
            {"Sovereign State": "Western Bloc 2 (e.g., USA)", "Per Capita GDP (Illustrative, USD)": 60000, "Access to Food (0-1)": 0.9, "Access to Shelter (0-1)": 0.85, "Agency Preservation Factor (0-1, from DAO)": 0.6, "Cultural Flourishing Score (0-1, from DAO)": 0.7, "UN Human Rights Charter Match (0 or 1)": 1, "UN SDGs Met (Conceptual %)": 80},
            {"Sovereign State": "Eastern Bloc 1 (e.g., China)", "Per Capita GDP (Illustrative, USD)": 12000, "Access to Food (0-1)": 0.8, "Access to Shelter (0-1)": 0.8, "Agency Preservation Factor (0-1, from DAO)": 0.5, "Cultural Flourishing Score (0-1, from DAO)": 0.6, "UN Human Rights Charter Match (0 or 1)": 0, "UN SDGs Met (Conceptual %)": 70},
            {"Sovereign State": "Eastern Bloc 2 (e.g., Russia)", "Per Capita GDP (Illustrative, USD)": 10000, "Access to Food (0-1)": 0.7, "Access to Shelter (0-1)": 0.7, "Agency Preservation Factor (0-1, from DAO)": 0.3, "Cultural Flourishing Score (0-1, from DAO)": 0.5, "UN Human Rights Charter Match (0 or 1)": 0, "UN SDGs Met (Conceptual %)": 60},
            {"Sovereign State": "Resource-Rich 3rd World 1 (e.g., OPEC)", "Per Capita GDP (Illustrative, USD)": 20000, "Access to Food (0-1)": 0.75, "Access to Shelter (0-1)": 0.6, "Agency Preservation Factor (0-1, from DAO)": 0.4, "Cultural Flourishing Score (0-1, from DAO)": 0.5, "UN Human Rights Charter Match (0 or 1)": 0, "UN SDGs Met (Conceptual %)": 65},
            {"Sovereign State": "Displaced Nations 1 (e.g., Bangladesh)", "Per Capita GDP (Illustrative, USD)": 2000, "Access to Food (0-1)": 0.3, "Access to Shelter (0-1)": 0.1, "Agency Preservation Factor (0-1, from DAO)": 0.1, "Cultural Flourishing Score (0-1, from DAO)": 0.2, "UN Human Rights Charter Match (0 or 1)": 0, "UN SDGs Met (Conceptual %)": 20}
        ];

        function calculate_self_worth_coefficient(state_data) {
            const access_food = state_data["Access to Food (0-1)"] || 0;
            const access_shelter = state_data["Access to Shelter (0-1)"] || 0;
            const agency_preservation = state_data["Agency Preservation Factor (0-1, from DAO)"] || 0;
            const cultural_flourishing = state_data["Cultural Flourishing Score (0-1, from DAO)"] || 0;
            const coefficient = ( 0.3 * access_food + 0.3 * access_shelter + 0.2 * agency_preservation + 0.2 * cultural_flourishing );
            return Math.round(coefficient * 100) / 100;
        }

        function check_un_charter_match(self_worth_coefficient) {
            return self_worth_coefficient >= 0.8 ? 1 : 0;
        }

        function calculate_zero_oil_gas_timeline(state_data) {
            const supply = state_data["Annual Oil Supply (MM Bbl/yr)"] || 0;
            const demand = state_data["Annual Oil Demand (MM Bbl/yr)"] || 0;
            const reserves_oil = state_data["Oil Reserves (Billion Barrels)"];

            if (reserves_oil === "N/A" || reserves_oil === "~Infinite") {
                if (supply >= demand) return "Self-Sufficient Now";
                if (supply < demand && reserves_oil === "~Infinite") return "Sustainable (Infinite Source)";
                return "Unknown (N/A Reserves)";
            }

            const reserves_oil_mm = reserves_oil * 1000;
            if (demand <= 0) return "N/A (No Demand)";
            
            const net_deficit_oil = demand - supply;
            if (net_deficit_oil <= 0) return "Self-Sufficient Now";
            
            const years = reserves_oil_mm / net_deficit_oil;
            return `${Math.floor(years)} years`;
        }

        function simulatePythonOutput() {
            let output = "";
            output += "--- Conceptual Geopolitical Resource & Self-Worth Simulation (Outputs to Console and JSON) ---\n";
            output += "Running simulated calculations based on stored conceptual data...\n";
            
            function formatTable(data, title) {
                let tableString = `\n--- ${title} ---\n`;
                if (!data || data.length === 0) { tableString += "No data to display.\n"; return tableString; }

                const headers = Object.keys(data[0]);
                const colWidths = {};
                headers.forEach(h => colWidths[h] = h.length);
                data.forEach(row => {
                    headers.forEach(h => colWidths[h] = Math.max(colWidths[h], String(row[h]).length));
                });

                tableString += headers.map(h => h.ljust(colWidths[h])).join(" | ") + "\n";
                tableString += headers.map(h => "-".repeat(colWidths[h])).join("-|-") + "\n";
                data.forEach(row => {
                    let displayRow = { ...row };
                    if (title === "Per Capita Self-Worth Coefficient & UN SDG Resolution Match" && row["Sovereign State"].indexOf("Global Average") === -1) {
                        const calculated_swc = calculate_self_worth_coefficient(row);
                        displayRow["Per Capita Self-Worth Coefficient (Calculated 0-1)"] = calculated_swc;
                        displayRow["UN Human Rights Charter Match (0 or 1)"] = check_un_charter_match(calculated_swc);
                    }
                    tableString += headers.map(h => String(displayRow[h]).ljust(colWidths[h])).join(" | ") + "\n";
                });
                return tableString;
            }

            if (!String.prototype.ljust) {
                String.prototype.ljust = function(width, char=' ') {
                    return this.length >= width ? this.toString() : this.toString() + char.repeat(width - this.length);
                };
            }

            const energyDataWithTimeline = CONCEPTUAL_ENERGY_DATA.map(row => {
                let newRow = { ...row };
                if ("Annual Oil Supply (MM Bbl/yr)" in newRow) {
                    newRow["Zero Oil/Gas Timeline"] = calculate_zero_oil_gas_timeline(newRow);
                }
                return newRow;
            });

            const selfWorthDataCalculated = CONCEPTUAL_SELF_WORTH_DATA.map(row => {
                let newRow = { ...row };
                if (newRow["Sovereign State"].indexOf("Global Average") === -1) {
                    newRow["Per Capita Self-Worth Coefficient (Calculated 0-1)"] = calculate_self_worth_coefficient(newRow);
                    newRow["UN Human Rights Charter Match (0 or 1)"] = check_un_charter_match(newRow["Per Capita Self-Worth Coefficient (Calculated 0-1)"]);
                }
                return newRow;
            });


            output += formatTable(energyDataWithTimeline, "Conceptual Global Energy Resource Allocation & Transition");
            output += formatTable(selfWorthDataCalculated, "Per Capita Self-Worth Coefficient & UN SDG Resolution Match");

            output += "\n--- Simulation Concluded ---";
            output += "\nThese tables and calculations are illustrative. Real-world implementation requires actual data from reputable sources and deeply nuanced models.";
            output += "\n\n--- Portal Geometry Calculation (from conceptual video analysis) ---\n";
            const video_analysis_result = {
                "pointing_angle_deg": 45.0, "forward_spin_rad_sec": 0.3,
                "num_euclidean_cuts": 5, "fractal_depth_factor": 0.7
            };
            output += `Conceptual Video Analysis: 20250626_190146_001.mp4\n`;
            output += `  Detected pointing vector angle: ${video_analysis_result.pointing_angle_deg.toFixed(2)} degrees\n`;
            output += `  Detected subtle forward motion spin: ${video_analysis_result.forward_spin_rad_sec.toFixed(2)} radians/sec\n`;
            output += `  Conceptual Euclidean Cuts identified: ${video_analysis_result.num_euclidean_cuts} with fractal depth factor: ${video_analysis_result.fractal_depth_factor.toFixed(2)}\n`;
            
            const portalParams = calculateVortexParameters(150, 5.5, video_analysis_result);
            output += `\nInitiating Portal Geometry Calculation (with Seked)...\n`;
            output += `Spinning Wood Input: 150.00 RPM\n`;
            output += `Egyptian Seked Value (Slope): 5.50\n`;
            output += `Conceptual Pythagorean Triangle: a=3.0, b=4.0, hypotenuse (c_prime)=5.00\n`;
            output += `Hypotenuse (c_prime) split by Phi: ${(portalParams.pythagorean_hypotenuse / 1.6180339887).toFixed(2)}\n`;
            output += `Conceptual Fractal Euclidean Shard Value (Remainder): ${portalParams.fractal_shard_value.toFixed(2)}\n`;
            output += `Vortex adjusted by Euclidean Cuts from video analysis.\n`;
            output += `Conceptual Vortex Parameters Calculated. Ready for 3D Visualization.\n`;
            output += `  Vortex Intensity: ${portalParams.vortex_intensity.toFixed(2)}\n`;
            output += `  Vortex Turbulence Factor: ${portalParams.vortex_turbulence_factor.toFixed(2)}\n`;
            output += `  D1-D9 Beam Status: ${portalParams.d1_to_d9_beam_status}\n`;


            codeOutputPre.textContent = output;
        }

        // --- Main App Initialization ---
        window.onload = () => {
            // Get DOM elements
            rpmValueDisplay = document.getElementById('rpmValue');
            sekedValueDisplay = document.getElementById('sekedValue');
            portalMessageElement = document.getElementById('portal-message-text');
            aletheianMessageElement = document.getElementById('aletheian-message');
            vortexStatusElement = document.getElementById('vortex-status');
            journeyLogElement = document.getElementById('journey-log');
            codeOutputPre = document.getElementById('code-output');

            // Set initial slider values and their displays
            document.getElementById('spinningWoodInput').value = spinningWoodRPM;
            rpmValueDisplay.textContent = spinningWoodRPM;
            document.getElementById('sekedValueInput').value = sekedValue;
            sekedValueDisplay.textContent = sekedValue;

            // Add event listeners for sliders
            document.getElementById('spinningWoodInput').addEventListener('input', (e) => {
                spinningWoodRPM = parseFloat(e.target.value);
                rpmValueDisplay.textContent = spinningWoodRPM;
            });
            document.getElementById('sekedValueInput').addEventListener('input', (e) => {
                sekedValue = parseFloat(e.target.value);
                sekedValueDisplay.textContent = sekedValue;
            });
            
            // Setup lift button handlers
            document.querySelectorAll('.floor-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    goToFloor(e.target.dataset.floor);
                });
            });
            document.getElementById('lift-button-right').addEventListener('click', onLiftCallClick);
            
            // Set initial active floor button
            document.querySelector(`.floor-button[data-floor="G"]`).classList.add('active');

            setupThreeJSScene();
            initAudio();
            simulatePythonOutput();
        };

        // --- Full cleanup on page unload ---
        window.onbeforeunload = () => {
            cancelAnimationFrame(animationFrameId);
            if (renderer) renderer.dispose();
            if (scene) scene.traverse(obj => {
                if (obj.isMesh) {
                    if (obj.geometry) obj.geometry.dispose();
                    if (obj.material) {
                        if (Array.isArray(obj.material)) {
                            obj.material.forEach(m => m.dispose());
                        } else {
                            m.material.dispose();
                        }
                    }
                }
            });
            if (controls) controls.dispose();
            
            if (liftSoundAscend) liftSoundAscend.dispose();
            if (liftSoundDescend) liftSoundDescend.dispose();
            if (doorOpenSound) doorOpenSound.dispose();
            if (doorCloseSound) doorCloseSound.dispose();
            if (Tone.context.state !== 'closed') Tone.context.close();

            if (videoElement) {
                videoElement.pause();
                videoElement.removeAttribute('src');
                videoElement.load();
            }
        };

    </script>
</body>
</html>
